# 01. Create OMPC build
cd ompc_docker_compile && docker build -t ompc-build .
cd ..


# 02. Create container
docker run --name ompc-build -v $PWD:/ompc/volume \
    --env WORK_DIR=/ompc/volume/ompc_docker_runtime/project \
    --env BUILD_DIR=/ompc/volume/ompc_docker_runtime/project/build \
    --env PROJECT_DIR=llvm-project-moheft \
    --env GIT_REPOSITORY=https://gitlab.com/gui.alm02/llvm-project-moheft.git \
    --env GIT_BRANCH=main \
    -it ompc-build


# 03. Execute build inside the container 
. ompc/compile-llvm.ssh
exit


# 04. Create OMPC runtime
cd ompc_docker_runtime && docker build -t ompc-runtime-moheft --build-arg BUILD_DIR=./project/build .
cd ..

# 05. Start a cluster.
cd ./ompc_docker_cluster/image_base/
/bin/bash generate_mpi_images.sh
cd ../../

# 06. Start a cluster.
cd ompc_docker_cluster
cd cluster_experiment # or cd cluster_test
sh start_cluster.sh
docker attach cluster_experiment_head_1 # or cd cluster_test_head_1

# 07. Execute an application:
# -np 8 = 1 MPI process to head and 7 to worker nodes
cd /volume/examples/matmul
chmod +x ./matmul
export OMPCLUSTER_SCHEDULER=nheft
mpirun -np 8 --hostfile /volume/ompc-host-file  ./matmul 80 20

